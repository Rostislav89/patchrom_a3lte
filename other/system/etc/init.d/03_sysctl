#!/system/bin/sh
# Copyright (c) 2017, Stripalov. All rights reserved.
# Apply TCP tweaks
toybox sysctl -w net.ipv4.tcp_timestamps=0
toybox sysctl -w net.ipv4.tcp_tw_reuse=1
toybox sysctl -w net.ipv4.tcp_sack=1
toybox sysctl -w net.ipv4.tcp_tw_recycle=1
toybox sysctl -w net.ipv4.tcp_window_scaling=1
toybox sysctl -w net.ipv4.tcp_keepalive_probes=5
toybox sysctl -w net.ipv4.tcp_keepalive_intvl=30
toybox sysctl -w net.ipv4.tcp_fin_timeout=30
toybox sysctl -w net.core.wmem_max=404480
toybox sysctl -w net.core.rmem_max=404480
toybox sysctl -w net.core.rmem_default=256960
toybox sysctl -w net.core.wmem_default=256960
toybox sysctl -w net.ipv4.tcp_wmem=4096,16384,404480
toybox sysctl -w net.ipv4.tcp_rmem=4096,87380,404480
toybox sysctl -w net.ipv4.conf.all.rp_filter=2
toybox sysctl -w net.ipv4.conf.default.rp_filter=2
toybox sysctl -w net.ipv4.tcp_max_syn_backlog=1024
toybox sysctl -w net.ipv4.tcp_synack_retries=2
toybox sysctl -w net.ipv4.tcp_moderate_rcvbuf=1
toybox sysctl -w net.ipv4.icmp_echo_ignore_all=1
toybox sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
toybox sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1
toybox sysctl -w net.ipv4.tcp_fin_timeout=15
toybox sysctl -w net.ipv4.route.flush=1
toybox sysctl -w net.ipv4.tcp_rfc1337=1
toybox sysctl -w net.ipv4.ip_no_pmtu_disc=0
toybox sysctl -w net.ipv4.tcp_ecn=0
toybox sysctl -w net.ipv4.tcp_fack=1
toybox sysctl -w net.ipv4.tcp_syn_retries=2
toybox sysctl -w net.ipv4.ip_forward=0
toybox sysctl -w net.ipv4.conf.all.accept_redirects=0
toybox sysctl -w net.ipv4.conf.all.secure_redirects=0
toybox sysctl -w net.ipv4.conf.all.send_redirects=0
toybox sysctl -w net.ipv4.conf.default.send_redirects=0
toybox sysctl -w net.ipv4.conf.default.accept_source_route=0
toybox sysctl -w net.ipv4.tcp_dsack=1
toybox sysctl -w net.ipv4.tcp_no_metrics_save=1
toybox sysctl -w net.core.netdev_max_backlog=30000
toybox sysctl -w net.ipv4.tcp_fastopen=1
toybox sysctl -w net.ipv4.tcp_slow_start_after_idle=0
# Apply VM tweaks
toybox sysctl -w vm.oom_dump_tasks=0
toybox sysctl -w vm.oom_kill_allocating_task=0
toybox sysctl -w vm.vfs_cache_pressure=10
toybox sysctl -w vm.overcommit_memory=1
toybox sysctl -w vm.overcommit_ratio=150
toybox sysctl -w vm.dirty_expire_centisecs=500
toybox sysctl -w vm.dirty_writeback_centisecs=3000
toybox sysctl -w vm.block_dump=0
toybox sysctl -w vm.laptop_mode=0
toybox sysctl -w vm.min_free_kbytes=512
toybox sysctl -w vm.extra_free_kbytes=1024
toybox sysctl -w vm.min_free_order_shift=5
toybox sysctl -w vm.page-cluster=0
toybox sysctl -w vm.dirty_background_ratio=10
toybox sysctl -w vm.dirty_ratio=20
toybox sysctl -w vm.swappiness=100
toybox sysctl -w vm.panic_on_oom=0
# Apply kernel tweaks
toybox sysctl -w kernel.random.read_wakeup_threshold=1708
toybox sysctl -w kernel.random.write_wakeup_threshold=2048
toybox sysctl -w kernel.msgmni=32768
toybox sysctl -w kernel.msgmax=8192
toybox sysctl -w kernel.msgmnb=16384
toybox sysctl -w kernel.shmmni=4096
toybox sysctl -w kernel.shmall=2097152
toybox sysctl -w kernel.shmmax=268435456
toybox sysctl -w kernel.sem='250 32000 100 128'
toybox sysctl -w fs.lease-break-time=8
toybox sysctl -w fs.inotify.max_queued_events=32768
toybox sysctl -w fs.inotify.max_user_instances=256
toybox sysctl -w fs.inotify.max_user_watches=16384
toybox sysctl -w fs.file-max=524288
toybox sysctl -w kernel.panic_on_oops=0
toybox sysctl -w kernel.panic=0
toybox sysctl -w fs.nr_open=1053696
toybox sysctl -w kernel.threads-max=525810
# Drop caches after applying settings
sync && toybox sysctl -w vm.drop_caches=3
